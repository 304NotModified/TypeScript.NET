/*!
 * @author electricessence / https://github.com/electricessence/
 * Licensing: MIT https://github.com/electricessence/TypeScript.NET/blob/master/LICENSE.md
 * Based upon Parallel.js: https://github.com/adambom/parallel.js/blob/master/lib/parallel.js
 */
!function(e){if("object"==typeof module&&"object"==typeof module.exports){var r=e(require,exports);void 0!==r&&(module.exports=r)}else"function"==typeof define&&define.amd&&define(["require","exports","../../Promises/Promise","../../Types","../Worker","../deferImmediate","../../Environment"],e)}(function(e,r){"use strict";function n(e,r){r||(r={});for(var n=0,t=Object.keys(e);n<t.length;n++){var o=t[n];void 0===r[o]&&(r[o]=e[o])}return r}function t(e,r,n,t){r&&(e.onmessage=r),n&&(e.onerror=n),t!==c&&e.postMessage(t)}function o(e){return e&&a.deferImmediate(function(){return e.terminate()}),null}var i=e("../../Promises/Promise"),s=e("../../Types"),u=e("../Worker"),a=e("../deferImmediate"),f=e("../../Environment"),c=void 0,l=typeof self!==s.Type.UNDEFINED?self.URL?self.URL:self.webkitURL:null,p=!(!f.isNodeJS&&!self.Worker),h={evalPath:f.isNodeJS?__dirname+"/eval.js":null,maxConcurrency:f.isNodeJS?e("os").cpus().length:navigator.hardwareConcurrency||4,allowSynchronous:!0,env:{},envNamespace:"env"},d=function(e){function r(r,n){e.call(this,function(e,o){t(r,function(r){e(r.data)},function(e){o(e)},n)},!0)}return __extends(r,e),r}(i.Promise),v=function(){function e(e){this.options=n(h,e),this._requiredScripts=[],this._requiredFunctions=[]}return e.prototype.getWorkerSource=function(e,r){var n=this._requiredScripts,t=this._requiredFunctions,o="";!f.isNodeJS&&n.length&&(o+='importScripts("'+n.join('","')+'");\r\n');for(var i=0,s=t;i<s.length;i++){var u=s[i],a=u.name,c=u.fn,l=c.toString();o+=a?"var "+a+" = "+l+";":l}r=JSON.stringify(r||{});var p=this.options.envNamespace;return o+(f.isNodeJS?'process.on("message", function(e) {global.'+p+" = "+r+";process.send(JSON.stringify(("+e.toString()+")(JSON.parse(e).data)))})":"self.onmessage = function(e) {var global = {}; global."+p+" = "+r+"';self.postMessage(("+e.toString()+")(e.data))}")},e.prototype.require=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];return this.requireThese(e)},e.prototype.requireThese=function(e){for(var r=0,n=e;r<n.length;r++){var t=n[r];switch(typeof t){case s.Type.STRING:this._requiredScripts.push(t);break;case s.Type.FUNCTION:this._requiredFunctions.push({fn:t});break;case s.Type.OBJECT:this._requiredFunctions.push(t);break;default:throw new TypeError("Invalid type.")}}return this},e.prototype._spawnWorker=function(e,r){var n,t=this.getWorkerSource(e,r);if(u["default"]===c)return c;var o=this._requiredScripts,i=this.options.evalPath;if(!i){if(f.isNodeJS)throw new Error("Can't use NodeJD without eval.js!");if(o.length)throw new Error("Can't use required scripts without eval.js!");if(!l)throw new Error("Can't create a blob URL in this browser!")}if(f.isNodeJS||o.length||!l)n=new u["default"](i),n.postMessage(t);else if(l){var s=new Blob([t],{type:"text/javascript"}),a=l.createObjectURL(s);n=new u["default"](a)}return n},e.prototype.startNew=function(e,r,t){var o=this,s=o._spawnWorker(r,n(o.options.env,t||{}));if(s)return new d(s,e).finallyThis(function(){return s.terminate()});if(o.options.allowSynchronous)return new i.Promise(function(n,t){try{n(r(e))}catch(o){t(o)}});throw new Error("Workers do not exist and synchronous operation not allowed!")},Object.defineProperty(e,"isSupported",{get:function(){return p},enumerable:!0,configurable:!0}),e.options=function(r){return new e(r)},e.require=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];return(new e).requireThese(r)},e.requireThese=function(r){return(new e).requireThese(r)},e.startNew=function(r,n,t){return(new e).startNew(r,n,t)},e.prototype.forEach=function(e,r,n){var t=this;return e&&e.length?(e=e.slice(),new i.Promise(function(s,u){for(var a,f=t.options.maxConcurrency,c=0,l=0,p=function(f,p){var h=t._spawnWorker(r,n);if(!h){if(!t.options.allowSynchronous)throw new Error("Workers do not exist and synchronous operation not allowed!");return i.Promise.all(e.map(function(e){return new i.Promise(function(n,t){try{n(r(e))}catch(o){t(o)}})})).thenThis(function(){return s},u),{value:void 0}}var v=function(){if(a&&(h=o(h)),h)if(p>c){var r=new d(h,e[c++]);r.thenSynchronous(v,function(e){a||(a=e,u(e),h=o(h))}).thenThis(function(){if(l++,l>p)throw Error("Resolved count exceeds data length.");l===p&&s()}).finallyThis(function(){return r.dispose()})}else h=o(h)};v()},h=0,v=e.length;!a&&c<Math.min(v,f);h++){var w=p(h,v);if("object"==typeof w)return w.value}})):new i.Fulfilled},e}();r.Parallel=v,Object.defineProperty(r,"__esModule",{value:!0}),r["default"]=v});
//# sourceMappingURL=Parallel.js.map
