/*!
 * @author electricessence / https://github.com/electricessence/
 * Licensing: MIT
 * Although most of the following code is written from scratch, it is
 * heavily influenced by Q (https://github.com/kriskowal/q) and uses some of Q's spec.
 */
var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};define(["require","exports","../Types","../Tasks/deferImmediate","../Tasks/defer","../Disposable/DisposableBase","../Exceptions/InvalidOperationException","../Exceptions/ArgumentException","../Exceptions/ArgumentNullException","../Disposable/ObjectPool","../Collections/Set"],function(t,e,n,r,i,o,s,l,u,a,c){"use strict";function h(t){return n["default"].hasMemberOfType(t,w,n["default"].FUNCTION)}function f(t,e,n){var r=e?e(t):t;return r&&h(r)?E.wrap(r):n(r)}function p(t,e){return function(){t.then(function(t){return e.resolve(t),e},function(t){return e.reject(t),e})}}function d(t,e,n){try{var r=n?n(e):e;t&&t.resolve(r)}catch(i){t.reject(i)}}function _(t,e,n){t instanceof E?t.thenThis(e,n):t.then(e,n)}var v=void 0,y="Promise",g=y+"State",w="then",m="target",b=function(t){function e(e,n,r){t.call(this),this._state=e,this._result=n,this._error=r,this._disposableObjectName=g}return __extends(e,t),e.prototype._onDispose=function(){this._state=v,this._result=v,this._error=v},e.prototype.getState=function(){return this._state},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPending",{get:function(){return this.getState()===E.State.Pending},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isSettled",{get:function(){return this.getState()!=E.State.Pending},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFulfilled",{get:function(){return this.getState()===E.State.Fulfilled},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isRejected",{get:function(){return this.getState()===E.State.Rejected},enumerable:!0,configurable:!0}),e.prototype.getResult=function(){return this._result},Object.defineProperty(e.prototype,"result",{get:function(){return this.throwIfDisposed(),this.getResult()},enumerable:!0,configurable:!0}),e.prototype.getError=function(){return this._error},Object.defineProperty(e.prototype,"error",{get:function(){return this.throwIfDisposed(),this.getError()},enumerable:!0,configurable:!0}),e}(o.DisposableBase);e.PromiseState=b;var j=function(t){function e(){t.call(this,E.State.Pending),this._disposableObjectName=y}return __extends(e,t),e.prototype.deferAll=function(){return this.throwIfDisposed(),new R(this)},e.prototype.defer=function(){this.throwIfDisposed();var t=E.pending();return r.deferImmediate(p(this,t)),t},e.prototype.delay=function(t){this.throwIfDisposed();var e=E.pending();return i.defer(p(this,e),t),e},e.prototype["catch"]=function(t){return this.throwIfDisposed(),this.then(v,t)},e.prototype["finally"]=function(t){return this.throwIfDisposed(),this.then(t,t)},e.prototype.finallyThis=function(t){return this.thenThis(t,t),this},e}(b);e.PromiseBase=j;var x=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.then=function(t,e){this.throwIfDisposed();try{switch(this.state){case E.State.Fulfilled:return t?f(this._result,t,E.resolve):this;case E.State.Rejected:return e?f(this._error,e,E.resolve):this}}catch(n){return new I(n)}throw new Error("Invalid state for a resolved promise.")},e.prototype.thenThis=function(t,e){switch(this.throwIfDisposed(),this.state){case E.State.Fulfilled:t&&t(this._result);break;case E.State.Rejected:e&&e(this._error)}return this},e}(j);e.Resolvable=x;var S=function(t){function e(e,n,r){t.call(this),this._result=n,this._error=r,this._state=e}return __extends(e,t),e}(x);e.Resolved=S;var D=function(t){function e(e){t.call(this,E.State.Fulfilled,e)}return __extends(e,t),e}(S),I=function(t){function e(e){t.call(this,E.State.Rejected,v,e)}return __extends(e,t),e}(S),P=function(t){function e(e){var n=this;if(t.call(this),this._target=e,!e)throw new u.ArgumentNullException(m);if(!h(e))throw new l.ArgumentException(m,"Must be a promise-like object.");e.then(function(t){n._state=E.State.Fulfilled,n._result=t,n._error=v,n._target=v},function(t){n._state=E.State.Rejected,n._error=t,n._target=v})}return __extends(e,t),e.prototype.then=function(e,n){this.throwIfDisposed();var r=this._target;if(!r)return t.prototype.then.call(this,e,n);var i=E.pending();return _(r,function(t){return d(i,t,e)},function(t){return n?d(i,t,n):i.reject(t)}),i},e.prototype.thenThis=function(e,n){this.throwIfDisposed();var r=this._target;return r?(_(r,e,n),this):t.prototype.thenThis.call(this,e,n)},e.prototype._onDispose=function(){t.prototype._onDispose.call(this),this._target=v},e}(x),E=function(t){function e(e,n){void 0===n&&(n=!1),t.call(this),e&&this.resolveUsing(e,!n)}return __extends(e,t),e.prototype.then=function(n,r){if(this.throwIfDisposed(),this._state)return t.prototype.then.call(this,n,r);var i=new e;return(this._waiting||(this._waiting=[])).push(C.PromiseCallbacks.init(n,r,i)),i},e.prototype.thenThis=function(e,n){return this.throwIfDisposed(),this._state?t.prototype.thenThis.call(this,e,n):((this._waiting||(this._waiting=[])).push(C.PromiseCallbacks.init(e,n)),this)},e.prototype._onDispose=function(){t.prototype._onDispose.call(this),this._resolvedCalled=v},e.prototype.resolveUsing=function(t,n,i){var o=this;if(void 0===n&&(n=!1),void 0===i&&(i=!1),!t)throw new u.ArgumentNullException("resolver");if(this._resolvedCalled)throw new s.InvalidOperationException(".resolve() already called.");if(this.state)throw new s.InvalidOperationException("Already resolved: "+e.State[this.state]);this._resolvedCalled=!0;var l=function(t){o._resolvedCalled=!1,o.reject(t)},a=function(t){o._resolvedCalled=!1,o.resolve(t)},c=function(){return t(function(t){if(t==o)throw new s.InvalidOperationException("Cannot resolve a promise as itself.");h(t)?_(t,a,l):a(t)},l)};n?r.deferImmediate(c):c()},e.prototype.resolve=function(t,n){if(void 0===n&&(n=!1),this.throwIfDisposed(),t==this)throw new s.InvalidOperationException("Cannot resolve a promise as itself.");if(this._state){if(!n||this._state==e.State.Fulfilled&&this._result===t)return;throw new s.InvalidOperationException("Changing the fulfilled state/value of a promise is not supported.")}if(this._resolvedCalled){if(n)throw new s.InvalidOperationException(".resolve() already called.")}else{this._state=e.State.Fulfilled,this._result=t,this._error=v;var r=this._waiting;if(r){this._waiting=v;for(var i=0,o=r;i<o.length;i++){var l=o[i],u=l.onFulfilled,a=l.promise,c=a;C.PromiseCallbacks.recycle(l),d(c,t,u)}r.length=0}}},e.prototype.reject=function(t,n){if(void 0===n&&(n=!1),this.throwIfDisposed(),this._state){if(!n||this._state==e.State.Rejected&&this._error===t)return;throw new s.InvalidOperationException("Changing the rejected state/value of a promise is not supported.")}if(this._resolvedCalled){if(n)throw new s.InvalidOperationException(".resolve() already called.")}else{this._state=e.State.Rejected,this._error=t;var r=this._waiting;if(r){this._waiting=null;for(var i=0,o=r;i<o.length;i++){var l=o[i],u=l.onRejected,a=l.promise,c=a;C.PromiseCallbacks.recycle(l),u?d(c,t,u):c.reject(t)}r.length=0}}},e}(x);e.Promise=E;var R=function(t){function e(e){if(t.call(this),this._parent=e,!(e&&e instanceof j))throw new l.ArgumentException(m,"Must be of type Promise.")}return __extends(e,t),e.prototype._onDisposed=function(){t.prototype._onDispose.call(this),this._parent=v},e.prototype.getState=function(){return this._parent.state},e.prototype.getResult=function(){return this._parent.result},e.prototype.getError=function(){return this._parent.error},e.prototype.then=function(t,e){this.throwIfDisposed();var n=this._parent.defer(),r=n.then(t,e);return n["finally"](function(){return C.recycle(n)}),r},e.prototype.thenThis=function(t,e){this.throwIfDisposed();var n=this._parent.defer();return n.thenThis(t,e),n["finally"](function(){return C.recycle(n)}),this},e.prototype.defer=function(){return this.throwIfDisposed(),this},e.prototype.deferAll=function(){return this.throwIfDisposed(),this},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),e}(j),O=function(t){function e(e){if(t.call(this,E.State.Pending,v),this._factory=e,!e)throw new u.ArgumentNullException("factory")}return __extends(e,t),e.prototype._onDispose=function(){t.prototype._onDispose.call(this),this._factory=v},e.prototype.getState=function(){return this.getResult(),this._state},e.prototype.getResult=function(){if(!this._state){try{this._result=this._factory(),this._state=E.State.Fulfilled}catch(t){this._error=t,this._state=E.State.Rejected}this._factory=v}return this._result},e.prototype.getError=function(){return this.getResult(),this._error},e.prototype.then=function(e,n){return this.throwIfDisposed(),this.getResult(),t.prototype.then.call(this,e,n)},e.prototype.thenThis=function(e,n){return this.throwIfDisposed(),this.getResult(),t.prototype.thenThis.call(this,e,n)},e.prototype.resolve=function(){return this.getResult(),this},Object.defineProperty(e.prototype,"isResolved",{get:function(){return!this._factory},enumerable:!0,configurable:!0}),e}(S);e.LazyResolved=O;var T=function(t){function e(e){if(t.call(this),this._resolver=e,!e)throw new u.ArgumentNullException("resolver");this._resolvedCalled=!0}return __extends(e,t),e.prototype._onDispose=function(){t.prototype._onDispose.call(this),this._resolver=v},e.prototype._onThen=function(){var t=this._resolver;t&&(this._resolver=v,this._resolvedCalled=!1,this.resolveUsing(t,!0))},e.prototype.then=function(e,n){return this._onThen(),t.prototype.then.call(this,e,n)},e.prototype.thenThis=function(e,n){return this._onThen(),t.prototype.thenThis.call(this,e,n)},e}(E);e.LazyPromise=T;var C;!function(t){function e(t){t&&(t instanceof E?n.recycle(t):t.dispose())}var n;!function(t){function e(){return o||(o=new a.ObjectPool(40,n))}function n(){return new E}function r(){var t=e().take();return t.__wasDisposed=!1,t._state=E.State.Pending,t}function i(t){t&&(t.dispose(),e().add(t))}var o;t.get=r,t.recycle=i}(n=t.pending||(t.pending={})),t.recycle=e;var r;!function(t){function e(){return o||(o=new a.ObjectPool(40,n))}function n(){return{onFulfilled:null,onRejected:null,promise:null}}function r(t,n,r){var i=e().take();return i.onFulfilled=t,i.onRejected=n,i.promise=r,i}function i(t){t.onFulfilled=null,t.onRejected=null,t.promise=null,e().add(t)}var o;t.init=r,t.recycle=i}(r=t.PromiseCallbacks||(t.PromiseCallbacks={}))}(C||(C={}));var E;!function(t){function e(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(!t&&!e.length)throw new u.ArgumentNullException("promises");var r=(Array.isArray(t)?t:[t]).concat(e);if(!r.length||r.every(function(t){return!t}))return new D(r);for(var i=r.length,o=0;i>o;o++){var s=r[o];s instanceof R&&(r[o]=s.parent)}return a(function(t,e){var n=[];n.length=i;for(var o=new c.Set(r.map(function(t,e){return e})),s=function(){e=null,t=null,r.length=0,r=null,o.dispose(),o=null},l=function(){var e=t;e&&!o.count&&(s(),e(n))},u=function(e,r){t&&(n[r]=e,o.remove(r),l())},a=function(t){var n=e;n&&(s(),n(t))},h=function(t){var e=r[t];e?e.then(function(e){return u(e,t)},a):o.remove(t),l()},f=0;o&&i>f;f++)h(f)})}function n(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r=t&&(Array.isArray(t)?t:[t]).concat(e);if(!r||!r.length||!(r=r.filter(function(t){return null!=t})).length)throw new l.ArgumentException("Nothing to wait for.");var i=r.length;if(1==i)return o(r[0]).defer();for(var s=0;i>s;s++){var u=r[s];if(u instanceof R&&(u=u.parent),u instanceof O){if(u.isResolved)return u.defer()}else if(u instanceof S||u instanceof j&&u.isSettled)return u.defer()}return a(function(t,e){for(var n=function(){e=null,t=null,r.length=0,r=null},i=function(t,e){t&&(n(),t(e))},o=function(e){return i(t,e)},s=function(t){return i(e,t)},l=0,u=r;l<u.length;l++){var a=u[l];if(!t)break;a.then(o,s)}})}function r(t){return h(t)?o(t):new D(t)}function i(t){return new I(t)}function o(e){if(!e)throw new u.ArgumentNullException(m);return e instanceof t?this:new P(e)}function s(t){if(!t)throw new u.ArgumentNullException(w);return new P({then:t})}function a(t){var e=C.pending.get();return t&&e.resolveUsing(t),e}!function(t){t[t.Pending=0]="Pending",t[t.Fulfilled=1]="Fulfilled",t[t.Rejected=-1]="Rejected"}(t.State||(t.State={}));var f=t.State;Object.freeze(f),t.all=e,t.race=n,t.resolve=r,t.reject=i;var p;!function(t){function e(t){return new O(t)}function n(t){return new T(t)}t.resolve=e,t.pending=n}(p=t.lazy||(t.lazy={})),t.wrap=o,t.createFrom=s,t.pending=a}(E=e.Promise||(e.Promise={}))});
//# sourceMappingURL=Promise.js.map
