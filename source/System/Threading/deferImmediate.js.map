{"version":3,"sources":["System/Threading/deferImmediate.ts"],"names":[],"mappings":"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","file":"System/Threading/deferImmediate.js","sourcesContent":["/*!\r\n * @author electricessence / https://github.com/electricessence/\r\n * Licensing: MIT https://github.com/electricessence/TypeScript.NET/blob/master/LICENSE.md\r\n * Based on code from: https://github.com/kriskowal/q\r\n */\r\n\r\n\r\nimport {Type} from \"../Types\";\r\nimport {LinkedNodeList} from \"../Collections/LinkedNodeList\";\r\nimport {Queue} from \"../Collections/Queue\";\r\nimport {Closure} from \"../FunctionTypes\";\r\nimport {ILinkedNode} from \"../Collections/ILinkedListNode\";\r\nimport {ICancellable} from \"./ICancellable\";\r\nimport {ObjectPool} from \"../Disposable/ObjectPool\";\r\n\r\ndeclare module process\r\n{\r\n\texport function nextTick(callback:Closure):void;\r\n\r\n\texport function toString():string;\r\n}\r\n\r\ninterface IDomain\r\n{\r\n\tenter():void;\r\n\texit():void;\r\n}\r\n\r\ninterface ITaskQueueEntry extends ILinkedNode<ITaskQueueEntry>\r\n{\r\n\ttask:Function;\r\n\tdomain?:IDomain;\r\n\tcontext?:any;\r\n\targs?:any[];\r\n\tcanceller:()=>boolean;\r\n}\r\n\r\n\r\nvar requestTick:()=>void;\r\nvar isNodeJS:boolean = false;\r\nvar flushing:boolean = false;\r\n\r\n// Use the fastest possible means to execute a task in a future turn\r\n// of the event loop.\r\n\r\n\r\nfunction flush():void\r\n{\r\n\t/* jshint loopfunc: true */\r\n\tvar entry:ITaskQueueEntry;\r\n\twhile(entry = immediateQueue.first)\r\n\t{\r\n\t\tlet {task, domain, context, args} = entry;\r\n\t\tentry.canceller();\r\n\t\tif(domain) domain.enter();\r\n\t\trunSingle(task, domain, context, args);\r\n\t}\r\n\r\n\tlet task:Closure;\r\n\twhile(task = laterQueue.dequeue())\r\n\t{\r\n\t\trunSingle(task);\r\n\t}\r\n\r\n\tflushing = false;\r\n}\r\n\r\n\r\n// linked list of tasks.  Using a real linked list to allow for removal.\r\nvar immediateQueue = new LinkedNodeList<ITaskQueueEntry>();\r\n\r\n// queue for late tasks, used by unhandled rejection tracking\r\nvar laterQueue = new Queue<Closure>();\r\n\r\nvar entryPool = new ObjectPool<ITaskQueueEntry>(40,\r\n\t()=><any>{},\r\n\to=>\r\n\t{\r\n\t\to.task = null;\r\n\t\to.domain = null;\r\n\t\to.context = null;\r\n\t\tif(o.args) o.args.length = 0;\r\n\t\to.args = null;\r\n\t\to.canceller = null;\r\n\t});\r\n\r\nfunction runSingle(task:Function, domain?:IDomain, context?:any, params?:any[]):void\r\n{\r\n\ttry\r\n\t{\r\n\t\ttask.apply(context, params);\r\n\t}\r\n\tcatch(e)\r\n\t{\r\n\t\tif(isNodeJS)\r\n\t\t{\r\n\t\t\t// In node, uncaught exceptions are considered fatal errors.\r\n\t\t\t// Re-throw them synchronously to interrupt flushing!\r\n\r\n\t\t\t// Ensure continuation if the uncaught exception is suppressed\r\n\t\t\t// listening \"uncaughtException\" events (as domains does).\r\n\t\t\t// Continue in next event to avoid tick recursion.\r\n\t\t\tif(domain)\r\n\t\t\t{\r\n\t\t\t\tdomain.exit();\r\n\t\t\t}\r\n\t\t\tsetTimeout(flush, 0);\r\n\t\t\tif(domain)\r\n\t\t\t{\r\n\t\t\t\tdomain.enter();\r\n\t\t\t}\r\n\r\n\t\t\tthrow e;\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// In browsers, uncaught exceptions are not fatal.\r\n\t\t\t// Re-throw them asynchronously to avoid slow-downs.\r\n\t\t\tsetTimeout(()=>\r\n\t\t\t{\r\n\t\t\t\tthrow e;\r\n\t\t\t}, 0);\r\n\t\t}\r\n\t}\r\n\r\n\tif(domain)\r\n\t{\r\n\t\tdomain.exit();\r\n\t}\r\n}\r\n\r\nfunction requestFlush():void\r\n{\r\n\tif(!flushing)\r\n\t{\r\n\t\tflushing = true;\r\n\t\trequestTick();\r\n\t}\r\n}\r\n\r\nexport function deferImmediate(task:Closure, context?:any):ICancellable\r\n/**\r\n * @param task The function to call.\r\n * @param context The context (aka this) to call on. Null or undefined = global.\r\n * @param args The parameters to pass to the function.\r\n * @returns {{cancel: (function(): boolean), dispose: (function(): undefined)}}\r\n */\r\nexport function deferImmediate(task:Function, context?:any, args?:any[]):ICancellable\r\nexport function deferImmediate(task:Closure|Function, context?:any, args?:any[]):ICancellable\r\n{\r\n\tvar entry:ITaskQueueEntry = entryPool.take();\r\n\tentry.task = task;\r\n\tentry.domain = isNodeJS && (<any>process)['domain'];\r\n\tentry.context = context;\r\n\tentry.args = args && args.slice();\r\n\tentry.canceller = ()=>\r\n\t{\r\n\t\tif(!entry) return false;\r\n\t\tlet r = !!immediateQueue.removeNode(entry);\r\n\t\tentryPool.add(entry);\r\n\t\tentry = null;\r\n\t\treturn r;\r\n\t};\r\n\r\n\timmediateQueue.addNode(entry);\r\n\r\n\trequestFlush();\r\n\r\n\treturn {\r\n\t\tcancel: entry.canceller,\r\n\t\tdispose: ()=> { entry && entry.canceller(); }\r\n\t}\r\n}\r\n\r\n\r\n// runs a task after all other tasks have been run\r\n// this is useful for unhandled rejection tracking that needs to happen\r\n// after all `then`d tasks have been run.\r\nexport function runAfterDeferred(task:Closure):void\r\n{\r\n\tlaterQueue.enqueue(task);\r\n\trequestFlush();\r\n}\r\n\r\n\r\nif(Type.isObject(process)\r\n\t&& process.toString()===\"[object process]\"\r\n\t&& process.nextTick)\r\n{\r\n\t/*\r\n\tEnsure is in a real Node environment, with a `process.nextTick`.\r\n\tTo see through fake Node environments:\r\n\t* Mocha test runner - exposes a `process` global without a `nextTick`\r\n\t* Browserify - exposes a `process.nexTick` function that uses\r\n\t  `setTimeout`. In this case `setImmediate` is preferred because\r\n\t   it is faster. Browserify's `process.toString()` yields\r\n\t  \"[object Object]\", while in a real Node environment\r\n\t  `process.nextTick()` yields \"[object process]\".\r\n\t*/\r\n\tisNodeJS = true;\r\n\r\n\trequestTick = ()=>\r\n\t{\r\n\t\tprocess.nextTick(flush);\r\n\t};\r\n\r\n}\r\nelse if(typeof setImmediate===\"function\")\r\n{\r\n\t// In IE10, Node.js 0.9+, or https://github.com/NobleJS/setImmediate\r\n\tif(typeof window!==\"undefined\")\r\n\t{\r\n\t\trequestTick = setImmediate.bind(window, flush);\r\n\t}\r\n\telse\r\n\t{\r\n\t\trequestTick = ()=>\r\n\t\t{\r\n\t\t\tsetImmediate(flush);\r\n\t\t};\r\n\t}\r\n\r\n}\r\nelse if(typeof MessageChannel!==\"undefined\")\r\n{\r\n\t// modern browsers\r\n\t// http://www.nonblocking.io/2011/06/windownexttick.html\r\n\tvar channel = new MessageChannel();\r\n\t// At least Safari Version 6.0.5 (8536.30.1) intermittently cannot create\r\n\t// working message ports the first time a page loads.\r\n\tchannel.port1.onmessage = function()\r\n\t{\r\n\t\trequestTick = requestPortTick;\r\n\t\tchannel.port1.onmessage = flush;\r\n\t\tflush();\r\n\t};\r\n\tvar requestPortTick = ()=>\r\n\t{\r\n\t\t// Opera requires us to provide a message payload, regardless of\r\n\t\t// whether we use it.\r\n\t\tchannel.port2.postMessage(0);\r\n\t};\r\n\trequestTick = ()=>\r\n\t{\r\n\t\tsetTimeout(flush, 0);\r\n\t\trequestPortTick();\r\n\t};\r\n\r\n}\r\nelse\r\n{\r\n\t// old browsers\r\n\trequestTick = ()=>\r\n\t{\r\n\t\tsetTimeout(flush, 0);\r\n\t};\r\n}\r\n\r\nexport default deferImmediate;"]}